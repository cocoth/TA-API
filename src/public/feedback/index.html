<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - Article</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="../css/style.css">
    <script src="../js/navbar.js"></script>
</head>

<body class="min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Article Info -->
        <div id="articleInfo" class="glass-effect p-6 rounded-xl border border-blue-400/30 mb-6">
            <a href="/" class="text-blue-400 hover:text-blue-300 mb-4 inline-block">← Kembali</a>
            <h1 id="articleTitle" class="text-3xl font-bold mb-4 text-blue-300">Loading...</h1>
            <p id="articleAuthor" class="text-sm text-gray-400"></p>
        </div>

        <!-- Feedback Form -->
        <div class="glass-effect p-6 rounded-xl border border-blue-400/30 mb-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Berikan Feedback Anda</h2>
            
            <div id="authWarning" class="hidden bg-yellow-500/20 border border-yellow-500/50 text-yellow-200 p-4 rounded-lg mb-4">
                <p class="font-medium">⚠️ Anda harus login terlebih dahulu untuk memberikan feedback.</p>
                <div class="mt-3 flex gap-3">
                    <a href="/auth/login" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Login</a>
                    <a href="/auth/register" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium">Register</a>
                </div>
            </div>

            <form id="feedbackForm" class="space-y-4">
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-200 mb-2">Feedback / Komentar</label>
                    <textarea id="content" name="content" rows="5" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white resize-none"
                        placeholder="Tulis feedback atau komentar Anda tentang artikel ini..."></textarea>
                    <p class="text-xs text-gray-400 mt-1">Minimal 3 karakter</p>
                </div>

                <div id="errorMessage" class="hidden text-red-500 text-sm"></div>
                <div id="successMessage" class="hidden text-green-500 text-sm"></div>

                <button type="submit"
                    class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200 font-medium cursor-pointer">
                    Submit Feedback
                </button>
            </form>
        </div>

        <!-- Feedbacks List -->
        <div class="glass-effect p-6 rounded-xl border border-blue-400/30">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Feedback dari Pengguna Lain</h2>
            <div id="feedbacksList" class="space-y-4">
                <p class="text-gray-400 text-center py-4">Loading feedbacks...</p>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');
        const articleTitle = urlParams.get('title');
        const articleAuthor = urlParams.get('author');

        const feedbackForm = document.getElementById('feedbackForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const authWarning = document.getElementById('authWarning');
        const feedbacksList = document.getElementById('feedbacksList');

        // Set article info
        if (articleTitle) {
            document.getElementById('articleTitle').textContent = decodeURIComponent(articleTitle);
        }
        if (articleAuthor) {
            document.getElementById('articleAuthor').textContent = `Oleh: ${decodeURIComponent(articleAuthor)}`;
        }

        // Check if user is logged in
        async function checkAuth() {
            try {
                const response = await fetch('/api/v1/user/me', {
                    credentials: 'include'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Load feedbacks for this article
        async function loadFeedbacks() {
            if (!articleId) {
                feedbacksList.innerHTML = '<p class="text-gray-400 text-center py-4">Invalid article ID</p>';
                return;
            }

            try {
                const response = await fetch(`/api/v1/feedbacks/comments/article/${encodeURIComponent(articleId)}`, {
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok && data.data && data.data.length > 0) {
                    feedbacksList.innerHTML = '';
                    data.data.forEach(feedback => {
                        const feedbackElement = document.createElement('div');
                        feedbackElement.className = 'border border-blue-400/20 rounded-lg p-4 bg-white/5';
                        feedbackElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-medium text-purple-400">${feedback.user.name}</p>
                                    <p class="text-xs text-gray-400">${new Date(feedback.createdAt).toLocaleString('id-ID')}</p>
                                </div>
                            </div>
                            <p class="text-gray-200">${feedback.content}</p>
                        `;
                        feedbacksList.appendChild(feedbackElement);
                    });
                } else {
                    feedbacksList.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada feedback untuk artikel ini. Jadilah yang pertama!</p>';
                }
            } catch (error) {
                feedbacksList.innerHTML = '<p class="text-red-400 text-center py-4">Gagal memuat feedbacks</p>';
            }
        }

        // Submit feedback
        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');

            const isLoggedIn = await checkAuth();
            if (!isLoggedIn) {
                authWarning.classList.remove('hidden');
                return;
            }

            const content = document.getElementById('content').value.trim();

            if (content.length < 3) {
                errorMessage.textContent = 'Feedback minimal 3 karakter';
                errorMessage.classList.remove('hidden');
                return;
            }

            if (!articleId || !articleTitle) {
                errorMessage.textContent = 'Data artikel tidak valid';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch('/api/v1/feedbacks/comments/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        articleId,
                        articleTitle: decodeURIComponent(articleTitle),
                        content
                    }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    successMessage.textContent = 'Feedback berhasil dikirim!';
                    successMessage.classList.remove('hidden');
                    document.getElementById('content').value = '';
                    
                    // Reload feedbacks
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                        loadFeedbacks();
                    }, 1500);
                } else if (response.status === 401) {
                    authWarning.classList.remove('hidden');
                } else {
                    errorMessage.textContent = data.message || 'Gagal mengirim feedback';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                errorMessage.textContent = 'Gagal terhubung ke server';
                errorMessage.classList.remove('hidden');
            }
        });

        // Load feedbacks on page load
        loadFeedbacks();
    </script>
</body>

</html>
